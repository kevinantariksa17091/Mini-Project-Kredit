@page "/registration/edit/{Id:int}"
@rendermode InteractiveServer
@using Mini_Project_Kredit.Models
@inject Mini_Project_Kredit.Services.CreditRegistrationService CreditRegistrationService
@inject Mini_Project_Kredit.Services.VillageService VillageService
@inject IWebHostEnvironment Env
@inject NavigationManager Nav

<PageTitle>Edit Registration</PageTitle>

<div class="register-container">
    <div class="register-box">
        <h3>Edit Registrasi</h3>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="@MessageCss">@Message</div>
        }

        @if (IsLoading)
        {
            <div class="alert alert-info">Memuat data...</div>
        }
        else
        {
            <EditForm Model="@Model" OnValidSubmit="@HandleUpdate">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label>NIK</label>
                    <InputText class="form-control" @bind-Value="Model.Nik" disabled />
                </div>

                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <InputText class="form-control" @bind-Value="Model.FullName" />
                    <ValidationMessage For="@(() => Model.FullName)" />
                </div>

                <div class="form-group">
                    <label>Alamat</label>
                    <InputText class="form-control" @bind-Value="Model.Address" />
                    <ValidationMessage For="@(() => Model.Address)" />
                </div>

                <div class="form-group">
                    <label>No. Telepon</label>
                    <InputText class="form-control" @bind-Value="Model.PhoneNumber" />
                    <ValidationMessage For="@(() => Model.PhoneNumber)" />
                </div>

                <div class="form-group">
                    <label>Username</label>
                    <InputText class="form-control" @bind-Value="Model.username" disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Cari Desa</label>
                    <InputText class="form-control"
                               Value="@_searchText"
                               ValueChanged="OnSearchChanged"
                               ValueExpression="(()=> _searchText)" />
                    <div class="text-muted small mt-1">
                        Keyword: @_searchText | Hasil: @districts.Count
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Pilih Desa</label>
                    <select class="form-select" @bind="Model.VillageId" @bind:after="OnVillageChanged">
                        <option value="">-- pilih desa --</option>
                        @foreach (var d in districts)
                        {
                            <option value="@d.id">@d.DisplayName</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Foto Profil (Max 2MB)</label>
                    <InputFile OnChange="OnFileSelected" accept=".jpg,.jpeg,.png,.webp" class="form-control" />

                    @if (!string.IsNullOrWhiteSpace(FileError))
                    {
                        <div class="text-danger small mt-1">@FileError</div>
                    }

                    @if (!string.IsNullOrWhiteSpace(PreviewUrl))
                    {
                        <div class="mt-2">
                            <img src="@PreviewUrl" style="max-width: 200px; border-radius: 10px;" />
                        </div>
                    }
                    else if (!string.IsNullOrWhiteSpace(Model.ProfileImagePath))
                    {
                        <div class="mt-2">
                            <img src="@Model.ProfileImagePath" style="max-width: 200px; border-radius: 10px;" />
                        </div>
                    }
                </div>

                <div class="small text-muted mt-2">
                    Tanggal Registrasi: @Model.RegistrationDate.ToString("yyyy-MM-dd HH:mm:ss")
                </div>

                <button class="btn btn-primary mt-3 w-100" type="submit" disabled="@IsSubmitting">
                    @(IsSubmitting ? "Menyimpan..." : "Simpan Perubahan")
                </button>

                <a class="btn btn-outline-secondary mt-2 w-100" href="/">Kembali</a>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private CreditRegistration Model = new();
    private bool IsSubmitting;
    private bool IsLoading = true;

    private string? Message;
    private string MessageCss = "alert alert-info";

    // village search
    private List<DesaApiRow> districts = new();
    private string _searchText = "";

    // upload
    private IBrowserFile? SelectedFile;
    private string? FileError;
    private string? PreviewUrl;

    protected override async Task OnInitializedAsync()
    {
        var existing = await CreditRegistrationService.GetByIdAsync(Id);
        if (existing == null)
        {
            MessageCss = "alert alert-danger";
            Message = "Data registrasi tidak ditemukan.";
            IsLoading = false;
            return;
        }

        Model = existing;
        IsLoading = false;
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value ?? "";

        if (_searchText.Length < 3)
        {
            districts.Clear();
            await InvokeAsync(StateHasChanged);
            return;
        }

        districts = await VillageService.SearchVillageAsync(_searchText.ToUpperInvariant());
        await InvokeAsync(StateHasChanged);
    }

    private void OnVillageChanged()
    {
        var selected = districts.FirstOrDefault(x => x.id == Model.VillageId);
        if (selected != null)
        {
            Model.VillageName = selected.desa;
            Model.DistrictName = selected.kecamatan;
            Model.RegencyName = selected.kabupaten;
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        FileError = null;
        PreviewUrl = null;

        var file = e.File;
        if (file == null) return;

        // size max 2MB
        const long maxBytes = 2 * 1024 * 1024;
        if (file.Size > maxBytes)
        {
            FileError = "Ukuran file maksimal 2MB.";
            return;
        }

        // ext validation
        var ext = Path.GetExtension(file.Name).ToLowerInvariant();
        var allowed = new[] { ".jpg", ".jpeg", ".png", ".webp" };
        if (!allowed.Contains(ext))
        {
            FileError = "Format file harus jpg/jpeg/png/webp.";
            return;
        }

        SelectedFile = file;

        // preview (read small bytes)
        using var stream = file.OpenReadStream(maxBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var base64 = Convert.ToBase64String(ms.ToArray());
        var contentType = file.ContentType;
        PreviewUrl = $"data:{contentType};base64,{base64}";
    }

    private async Task<string?> SaveFileAsync()
    {
        if (SelectedFile == null) return null;

        const long maxBytes = 2 * 1024 * 1024;

        var ext = Path.GetExtension(SelectedFile.Name).ToLowerInvariant();
        var fileName = $"{Guid.NewGuid():N}{ext}";

        var folder = Path.Combine(Env.WebRootPath, "uploads", "profiles");
        Directory.CreateDirectory(folder);

        var fullPath = Path.Combine(folder, fileName);

        await using var fs = new FileStream(fullPath, FileMode.Create);
        await using var stream = SelectedFile.OpenReadStream(maxBytes);
        await stream.CopyToAsync(fs);

        // return relative url to be used in <img src>
        return $"/uploads/profiles/{fileName}";
    }

    private async Task HandleUpdate()
    {
        Message = null;
        FileError = null;

        try
        {
            IsSubmitting = true;

            // save photo if uploaded
            var savedPath = await SaveFileAsync();
            if (!string.IsNullOrWhiteSpace(savedPath))
                Model.ProfileImagePath = savedPath;

            var result = await CreditRegistrationService.UpdateRegistrationAsync(Model);

            MessageCss = result.Success ? "alert alert-success" : "alert alert-danger";
            Message = result.Message;
        }
        catch (Exception ex)
        {
            MessageCss = "alert alert-danger";
            Message = $"Terjadi error: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
